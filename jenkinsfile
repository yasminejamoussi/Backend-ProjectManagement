pipeline {
    agent any

    environment {
        BACKEND_REPO = 'https://github.com/yasminejamoussi/Backend-ProjectManagement.git'
        FRONTEND_REPO = 'https://github.com/yasminejamoussi/FrontEnd-ProjectManagement.git'
        SONAR_TOKEN = credentials('sonarqube-token')
    }

    stages {
        stage('Debug Credentials') {
            steps {
                script {
                    echo "SonarQube Token r√©cup√©r√©: ${SONAR_TOKEN}"
                }
            }
        }

        stage('Checkout Code') {
            steps {
                script {
                    echo "üßπ Nettoyage de l'espace de travail..."
                    cleanWs()
                    sh "git config --global http.postBuffer 524288000"
                    sh "git config --global https.postBuffer 524288000"

                    echo "üì• Clonage du Backend..."
                    dir('backend') {
                        sh "git clone -b picicd ${BACKEND_REPO} ."
                        sh "git fetch origin"
                        sh "git checkout picicd"
                        sh "git pull origin picicd"
                    }

                    echo "üì• Clonage du Frontend..."
                    retry(3) {
                        dir('frontend') {
                            sh "git clone --progress --verbose ${FRONTEND_REPO} ."
                        }
                    }

                    // D√©placer docker-compose.yaml vers la racine
                    echo "üìÇ D√©placement de docker-compose.yaml vers la racine..."
                    sh 'mv backend/docker-compose.yaml . || echo "‚ùå docker-compose.yaml not found in backend"'
                    sh 'ls -la docker-compose.yaml || echo "‚ùå docker-compose.yaml not found at root"'
                }
            }
        }

        stage('Debug Docker Compose File') {
            steps {
                script {
                    echo "üìÇ V√©rification des fichiers dans le r√©pertoire principal..."
                    sh 'ls -la'
                    echo "üìÇ V√©rification des fichiers dans backend..."
                    dir('backend') {
                        sh 'ls -la'
                    }
                    echo "üìÇ V√©rification des fichiers dans frontend..."
                    dir('frontend') {
                        sh 'ls -la'
                    }
                }
            }
        }

        stage('Install Frontend Dependencies') {
            steps {
                script {
                    dir('frontend') {
                        echo "üì¶ Installation des d√©pendances du frontend..."
                        sh 'npm install'
                    }
                }
            }
        }

        stage('Install Backend Dependencies') {
            steps {
                script {
                    dir('backend') {
                        echo "üì¶ Installation des d√©pendances du backend..."
                        sh 'npm install'
                    }
                }
            }
        }

        stage('Install Docker Compose') {
            steps {
                script {
                    sh '''
                        if ! command -v docker-compose >/dev/null 2>&1; then
                            echo "Installing Docker Compose..."
                            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                            sudo chmod +x /usr/local/bin/docker-compose
                        fi
                        docker-compose --version
                    '''
                }
            }
        }

        stage('Clean Docker Environment') {
            steps {
                echo "üßπ Nettoyage de l'environnement Docker..."
                sh 'docker-compose -f docker-compose.yaml down -v --rmi local || true'
                sh 'docker system prune -f || true'
            }
        }

        stage('Start Docker Services') {
            steps {
                script {
                    echo "üöÄ D√©marrage des services Docker..."
                    sh '''
                        if [ -f docker-compose.yaml ]; then
                            docker-compose -f docker-compose.yaml up -d || (echo "‚ùå √âchec du d√©marrage des services Docker, v√©rifiez les logs" && exit 1)
                            # Attendre que MongoDB soit pr√™t
                            sleep 10
                            # V√©rifier que les conteneurs sont en cours d'ex√©cution
                            docker ps | grep mongo-test || (echo "‚ùå Conteneur mongo-test non d√©marr√©" && exit 1)
                            docker ps | grep mongodb || (echo "‚ùå Conteneur mongodb non d√©marr√©" && exit 1)
                        else
                            echo "‚ùå docker-compose.yaml introuvable, arr√™t du pipeline..."
                            exit 1
                        fi
                    '''
                }
            }
        }

        stage('Check Docker Compose Installation') {
            steps {
                script {
                    sh 'which docker-compose || echo "‚ùå docker-compose non trouv√©"'
                }
            }
        }

        stage('Unit Test Backend') {
            steps {
                script {
                    dir('backend') {
                        sh 'npm install --save-dev jest-junit'
                        timeout(time: 5, unit: 'MINUTES') {
                            withEnv(['MONGO_TEST_URI=mongodb://testuser:testpass@mongo-test:27017/testdb?authSource=admin', 'NODE_ENV=test']) {
                                sh 'npm test -- --ci --forceExit --reporters=default --reporters=jest-junit || (echo "Tests failed, check logs" && cat jest-junit.xml && exit 1)'
                            }
                        }
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv('scanner') {
                        dir('backend') {
                            echo "üöÄ D√©marrage de l'analyse SonarQube..."
                            sh "echo 'SonarQube Server URL: ${env.SONAR_HOST_URL}'"
                            sh "echo 'SonarQube Token: ${SONAR_TOKEN}'"
                            sh "curl -s http://192.168.33.10:9000 || echo 'ERROR: Cannot reach SonarQube server'"
                            timeout(time: 15, unit: 'MINUTES') {
                                withEnv(["SONAR_LOGIN=${SONAR_TOKEN}"]) {
                                    sh """
                                        ${scannerHome}/bin/sonar-scanner \
                                        -Dsonar.projectKey=projectpi \
                                        -Dsonar.sources=src \
                                        -Dsonar.exclusions=**/node_modules/**,**/*.test.js,**/coverage/**,src/models/LoginAttempt.js \
                                        -Dsonar.host.url=http://192.168.33.10:9000 \
                                        -Dsonar.login=\${SONAR_LOGIN} \
                                        -Dsonar.javascript.node.maxspace=3072 \
                                        -Dsonar.verbose=true \
                                        -Dsonar.scanner.skipJstsAnalysis=true \
                                        -Dsonar.javascript.enabled=false
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Build Frontend') {
            steps {
                script {
                    dir('frontend') {
                        echo "üõ†Ô∏è Construction du frontend..."
                        sh 'npm run build'
                    }
                }
            }
        }

        stage('Debug Directory') {
            steps {
                echo "üìÇ Contenu de la racine :"
                sh 'ls -la'
                dir('backend') {
                    echo "üìÇ Contenu de backend :"
                    sh 'ls -la'
                }
                dir('frontend') {
                    echo "üìÇ Contenu de frontend :"
                    sh 'ls -la'
                }
            }
        }

        stage('Check Docker Compose') {
            steps {
                script {
                    sh 'docker-compose --version'
                }
            }
        }

        stage('Building Docker Images') {
            steps {
                script {
                    echo "üöÄ Build des images Docker..."
                    sh 'docker-compose -f docker-compose.yaml build || (echo "‚ùå √âchec de la construction des images Docker, v√©rifiez les logs" && exit 1)'
                }
            }
        }

        stage('Run Application') {
            steps {
                script {
                    echo "üöÄ D√©marrage de l'application..."
                    sh 'docker-compose -f docker-compose.yaml up -d || (echo "‚ùå √âchec du d√©marrage de l\'application, v√©rifiez les logs" && exit 1)'
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline ex√©cut√© avec succ√®s !'
        }
        failure {
            echo '‚ùå Le pipeline a √©chou√©. V√©rifiez les logs.'
            sh 'docker-compose -f docker-compose.yaml logs || true'
        }
        always {
            node('master') {
                echo "üßπ Nettoyage de l'environnement Docker..."
                sh 'docker-compose -f docker-compose.yaml down -v --rmi local || true'
                sh 'docker system prune -f || true'
                echo "üìÇ Nettoyage de l'espace de travail apr√®s ex√©cution..."
                cleanWs()
            }
        }
    }
}